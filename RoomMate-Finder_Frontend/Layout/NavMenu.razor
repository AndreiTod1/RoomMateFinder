﻿@using RoomMate_Finder_Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IProfileService ProfileService
@inject AuthenticationStateProvider AuthenticationStateProvider

<MudAppBar Elevation="1" Dense="false" Color="Color.Primary">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                   Color="Color.Inherit" 
                   Edge="Edge.Start" 
                   OnClick="@((e) => DrawerToggle())" />
    
    <MudSpacer />
    
    @* <MudText Typo="Typo.h5" Class="fw-bold"> *@
    @*     <MudIcon Icon="@Icons.Material.Filled.Home" Class="me-2" /> *@
    @*     RoomMate Finder *@
    @* </MudText> *@
    
    <MudSpacer />

    <AuthorizeView>
        <Authorized>
            <MudChip T="string" Color="Color.Secondary" 
                     Icon="@Icons.Material.Filled.Person" 
                     Label="true" 
                     Class="me-2">
                Salut, @context.User.Identity?.Name
            </MudChip>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Secondary" 
                       StartIcon="@Icons.Material.Filled.Logout"
                       OnClick="OnLogout">
                Logout
            </MudButton>
        </Authorized>
        <NotAuthorized>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Secondary" 
                       StartIcon="@Icons.Material.Filled.Login"
                       Href="/login"
                       Class="me-2">
                Login
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Secondary" 
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       Href="/register">
                Register
            </MudButton>
        </NotAuthorized>
    </AuthorizeView>
</MudAppBar>

<MudDrawer @bind-Open="_drawerOpen" 
           Elevation="2" 
           ClipMode="DrawerClipMode.Always">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6" Class="fw-bold">
            <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="me-2" />
            Meniu Principal
        </MudText>
    </MudDrawerHeader>
    
    <MudNavMenu>
        <MudNavLink Href="/" 
                    Match="NavLinkMatch.All" 
                    Icon="@Icons.Material.Filled.Dashboard">
            Dashboard
        </MudNavLink>
        
        <AuthorizeView>
            <Authorized>
                <MudNavGroup Title="Caută Colegi" 
                             Icon="@Icons.Material.Filled.People" 
                             Expanded="true">

                    <MudNavLink OnClick="@(async () => await GoToMyProfile())" 
                                Icon="@Icons.Material.Filled.AccountCircle">
                        Profilul Meu
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavGroup Title="Matching" 
                             Icon="@Icons.Material.Filled.Favorite" 
                             Expanded="false">
                    <MudNavLink Href="/matches" 
                                Icon="@Icons.Material.Filled.Whatshot">
                        Descoperă Oameni
                    </MudNavLink>
                    <MudNavLink Href="/my-matches" 
                                Icon="@Icons.Material.Filled.FavoriteBorder">
                        Match-urile Mele
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavGroup Title="Conversații" 
                             Icon="@Icons.Material.Filled.Chat" 
                             Expanded="false">
                    <MudNavLink Href="/conversations" 
                                Icon="@Icons.Material.Filled.Forum">
                        Mesajele Mele
                    </MudNavLink>
                </MudNavGroup>
                
                <MudNavGroup Title="Camere" 
                             Icon="@Icons.Material.Filled.Home" 
                             Expanded="false">
                    <MudNavLink Href="/listings" 
                                Icon="@Icons.Material.Filled.Search">
                        Căută Camere
                    </MudNavLink>
                </MudNavGroup>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Roles="Admin">
            <Authorized>
                <MudDivider Class="my-2" />
                <MudNavGroup Title="Administrare" 
                             Icon="@Icons.Material.Filled.AdminPanelSettings" 
                             Expanded="true">
                    <MudNavLink Href="/admin/users" 
                                Icon="@Icons.Material.Filled.People">
                        Utilizatori
                    </MudNavLink>
                    <MudNavLink Href="/admin/listings" 
                                Icon="@Icons.Material.Filled.Home">
                        Anunțuri
                    </MudNavLink>
                </MudNavGroup>
            </Authorized>
        </AuthorizeView>
        
        <MudDivider Class="my-2" />
        
        <MudNavLink Href="/about" 
                    Icon="@Icons.Material.Filled.Info">
            Despre Noi
        </MudNavLink>
        <MudNavLink Href="/contact" 
                    Icon="@Icons.Material.Filled.ContactMail">
            Contact
        </MudNavLink>
    </MudNavMenu>
</MudDrawer>

@code {
    private bool _drawerOpen = true;

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task OnLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }

    private async Task GoToMyProfile()
    {
        try
        {
            // Prefer calling the backend /profiles/me which validates token and returns profile
            var profile = await ProfileService.GetCurrentAsync();
            if (profile != null)
            {
                Navigation.NavigateTo($"/profile/{profile.Id}");
                return;
            }
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        catch
        {
            // ignore and fallback to claims
        }

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? user.FindFirst("sub")?.Value;
                if (Guid.TryParse(idClaim, out var id))
                {
                    Navigation.NavigateTo($"/profile/{id}");
                    return;
                }
            }
        }
        catch
        {
            // ignore
        }

        // fallback: go to home
        Navigation.NavigateTo("/");
    }
}