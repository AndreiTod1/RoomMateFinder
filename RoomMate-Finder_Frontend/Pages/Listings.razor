@page "/listings"
@using Microsoft.AspNetCore.Authorization
@using RoomMate_Finder_Frontend.Services
@attribute [Authorize]
@inject IListingService ListingService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<PageTitle>Available Rooms - RoomMate Finder</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <!-- Header -->
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <MudStack>
            <MudText Typo="Typo.h3" Class="fw-bold">
                <MudIcon Icon="@Icons.Material.Filled.Home" Class="me-3" />
                Available Rooms
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Find your perfect room from our listings.
            </MudText>
        </MudStack>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.FilterList" OnClick="ToggleFilters">
            Filters
        </MudButton>
    </MudStack>

    <!-- Filters -->
    @if (showFilters)
    {
        <MudCard Class="mb-6 pa-4" Elevation="2" Style="border-radius: 12px;">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="4">
                    <MudTextField T="string" @bind-Value="filterCity" Label="City" Variant="Variant.Outlined" Clearable="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField T="decimal?" @bind-Value="filterMinPrice" Label="Min Price (€)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField T="decimal?" @bind-Value="filterMaxPrice" Label="Max Price (€)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12">
                    <MudStack Row Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters">Apply Filters</MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters">Clear</MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCard>
    }

    <!-- Content -->
    @if (isLoading)
    {
        <MudContainer Class="text-center py-8">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Loading rooms...</MudText>
        </MudContainer>
    }
    else if (!listings.Any())
    {
        <MudContainer Class="text-center py-8">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">No rooms found</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">Try adjusting your filters or check back later.</MudText>
        </MudContainer>
    }
    else
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Showing @listings.Count of @totalCount rooms</MudText>

        <MudGrid Spacing="4">
            @foreach (var listing in listings)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="listing-card h-100" Elevation="3" Style="border-radius: 16px; cursor: pointer;" @onclick="@(() => ViewRoom(listing.Id))">
                        <!-- Thumbnail Image -->
                        @if (!string.IsNullOrEmpty(listing.ThumbnailPath))
                        {
                            <MudCardMedia Image="@GetImageUrl(listing.ThumbnailPath)" Height="180" />
                        }
                        else
                        {
                            <div class="d-flex align-center justify-center" style="height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Large" Style="color: rgba(255,255,255,0.8);" />
                            </div>
                        }
                        
                        <MudCardContent Class="pa-4">
                            <MudStack Spacing="2">
                                <!-- Price Badge -->
                                <MudChip T="string" Color="Color.Primary" Size="Size.Medium" Icon="@Icons.Material.Filled.Euro">
                                    @listing.Price €/month
                                </MudChip>

                                <!-- Title -->
                                <MudText Typo="Typo.h6" Class="fw-bold">@listing.Title</MudText>

                                <!-- Location -->
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Color="Color.Secondary" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@listing.City, @listing.Area</MudText>
                                </MudStack>

                                <!-- Available From -->
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Available from @listing.AvailableFrom.ToShortDateString()</MudText>
                                </MudStack>

                                <!-- Amenities -->
                                @if (listing.Amenities.Any())
                                {
                                    <MudStack Row Spacing="1" Wrap="Wrap.Wrap" Class="mt-2">
                                        @foreach (var amenity in listing.Amenities.Take(3))
                                        {
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@amenity</MudChip>
                                        }
                                        @if (listing.Amenities.Count > 3)
                                        {
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">+@(listing.Amenities.Count - 3) more</MudChip>
                                        }
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions Class="pa-4 pt-0">
                            <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true" StartIcon="@Icons.Material.Filled.Visibility">
                                View Details
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <!-- Pagination -->
        <MudStack Row Justify="Justify.Center" Class="mt-6">
            <MudPagination Color="Color.Primary" Count="@totalPages" Selected="@currentPage" SelectedChanged="OnPageChanged" />
        </MudStack>
    }
</MudContainer>

<style>
    .listing-card {
        transition: all 0.3s ease;
    }
    .listing-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
</style>

@code {
    private List<ListingSummaryDto> listings = new();
    private bool isLoading = true;
    private bool showFilters = false;
    private int currentPage = 1;
    private readonly int pageSize = 12;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    // Filters
    private string? filterCity;
    private decimal? filterMinPrice;
    private decimal? filterMaxPrice;
    private string _apiBaseUrl = "";

    protected override async Task OnInitializedAsync()
    {
        // Fallback URL for local development
        _apiBaseUrl = Configuration["ApiBaseUrl"] ?? "http://localhost:5111";
        await LoadListings();
    }

    private async Task LoadListings()
    {
        isLoading = true;
        try
        {
            var request = new ListingsSearchRequest(
                City: filterCity,
                MinPrice: filterMinPrice,
                MaxPrice: filterMaxPrice,
                Page: currentPage,
                PageSize: pageSize
            );
            var response = await ListingService.SearchAsync(request);
            listings = response.Listings;
            totalCount = response.TotalCount;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading listings: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleFilters() => showFilters = !showFilters;

    private async Task ApplyFilters()
    {
        currentPage = 1;
        showFilters = false;
        await LoadListings();
    }

    private async Task ClearFilters()
    {
        filterCity = null;
        filterMinPrice = null;
        filterMaxPrice = null;
        currentPage = 1;
        await LoadListings();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadListings();
    }

    private string GetImageUrl(string path)
    {
        return path.StartsWith("http") ? path : $"{_apiBaseUrl}{path}";
    }

    private void ViewRoom(Guid id)
    {
        Navigation.NavigateTo($"/room/{id}");
    }
}
