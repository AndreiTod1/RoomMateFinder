@page "/my-matches"
@using Microsoft.AspNetCore.Authorization
@using RoomMate_Finder_Frontend.Services
@using RoomMate_Finder_Frontend.Models
@attribute [Authorize]
@inject IMatchingService MatchingService
@inject IProfileService ProfileService
@inject IConversationService ConversationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<PageTitle>Match-urile mele</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <div class="d-flex align-center gap-3 mb-6">
        <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Error" Size="Size.Large" />
        <div>
            <MudText Typo="Typo.h5" Style="font-weight: 700;">Match-urile Mele</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Interacționează cu persoanele compatibile</MudText>
        </div>
    </div>

    @if (_loading)
    {
        <div class="d-flex justify-center py-8">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        </div>
    }
    else if (_error != null)
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    else if (!_matches.Any())
    {
        <div class="d-flex flex-column align-center justify-center py-12 px-4 text-center">
            <div style="background: #fdf2f2; padding: 24px; border-radius: 50%; margin-bottom: 24px;">
                <MudIcon Icon="@Icons.Material.Filled.FavoriteBorder" Size="Size.Large" Style="font-size: 3rem; color: #ef4444;" />
            </div>
            <MudText Typo="Typo.h6" Class="mb-2">Încă nu ai niciun match</MudText>
            <MudText Color="Color.Secondary" Class="mb-6" Style="max-width: 400px;">
                Nu te descuraja! Continuă să explorezi profiluri pentru a găsi colegul de cameră ideal.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Href="/discover" StartIcon="@Icons.Material.Filled.Explore" Class="rounded-pill px-8">
                Descoperă Profiluri
            </MudButton>
        </div>
    }
    else
    {
        <MudGrid>
            @foreach (var match in _matches)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Class="match-card h-100 d-flex flex-column" Style="border-radius: 16px; overflow: hidden; transition: all 0.2s;">
                        <div style="position: relative; padding-top: 100%;">
                            @if (!string.IsNullOrEmpty(match.ProfilePicturePath))
                            {
                                <img src="@GetProfilePictureUrl(match.ProfilePicturePath)" 
                                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" />
                            }
                            else
                            {
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #f3f4f6; color: #9ca3af; font-size: 3rem; font-weight: 600;">
                                    @GetInitials(match.FullName)
                                </div>
                            }
                            
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 40px 16px 16px;">
                                <MudText Typo="Typo.h6" Style="color: white; font-weight: 600; line-height: 1.2;">@match.FullName</MudText>
                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">@match.Age ani</MudText>
                            </div>
                        </div>
                        
                        <MudCardContent Class="flex-grow-1 pt-3 pb-2 px-4">
                            <!-- Basic Info -->
                            @if (!string.IsNullOrEmpty(match.University))
                            {
                                <div class="d-flex align-center gap-2 mb-2" style="color: #4b5563;">
                                    <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" Color="Color.Default" style="font-size: 1.1rem; opacity: 0.6;" />
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@match.University</MudText>
                                </div>
                            }
                            
                            <!-- Tags -->
                            <div class="d-flex flex-wrap gap-1 mb-3">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Surface" Style="background-color: #f3f4f6;">@match.Gender</MudChip>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Surface" Style="background-color: #f3f4f6;">@match.Lifestyle</MudChip>
                            </div>

                            <!-- Bio -->
                            @if (!string.IsNullOrEmpty(match.Bio))
                            {
                                <MudText Typo="Typo.body2" Class="mb-3" Style="color: #6b7280; font-style: italic; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    "@(match.Bio)"
                                </MudText>
                            }

                            <!-- Interests -->
                            @if (!string.IsNullOrEmpty(match.Interests))
                            {
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    @foreach (var interest in match.Interests.Split(',', StringSplitOptions.RemoveEmptyEntries).Take(2))
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary" Style="border-color: #e5e7eb; color: #6b7280;">@interest.Trim()</MudChip>
                                    }
                                    @if(match.Interests.Split(',', StringSplitOptions.RemoveEmptyEntries).Length > 2)
                                    {
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default" Style="border-color: #e5e7eb; color: #9ca3af;">+@(match.Interests.Split(',', StringSplitOptions.RemoveEmptyEntries).Length - 2)</MudChip>
                                    }
                                </div>
                            }
                            
                            <div class="d-flex align-center justify-center gap-1 mt-auto pt-2" style="color: #9ca3af; font-size: 0.75rem; border-top: 1px solid #f3f4f6;">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" style="font-size: 0.9rem;" />
                                <span>Match din @match.MatchedAt.ToLocalTime().ToString("dd MMM")</span>
                            </div>
                        </MudCardContent>
                        
                        <div class="px-4 pb-4">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       FullWidth="true" 
                                       Class="rounded-pill"
                                       OnClick="@(() => StartConversation(match))">
                                Mesaj
                            </MudButton>
                        </div>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<style>
    .match-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.1) !important;
    }
</style>

@code {
    private List<UserMatchDto> _matches = new();
    private bool _loading = true;
    private string? _error;
    private string _apiBaseUrl = "";

    protected override async Task OnInitializedAsync()
    {
        _apiBaseUrl = Configuration["ApiBaseUrl"] ?? "";
        try
        {
            var me = await ProfileService.GetCurrentAsync();
            if (me == null) { Navigation.NavigateTo("/login"); return; }
            _matches = await MatchingService.GetMyMatchesAsync(me.Id);
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _loading = false; }
    }

    private string GetProfilePictureUrl(string? path)
    {
        if (string.IsNullOrEmpty(path)) return "";
        return path.StartsWith("http") ? path : $"{_apiBaseUrl}{path}";
    }
    
    private static string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2 ? $"{parts[0][0]}{parts[1][0]}".ToUpper() : name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private async Task StartConversation(UserMatchDto match)
    {
        try
        {
            var existingConversations = await ConversationService.GetConversationsAsync();
            var existing = existingConversations.FirstOrDefault(c => c.OtherUserId == match.UserId);
            
            if (existing != null)
                Navigation.NavigateTo($"/conversations/{existing.Id}");
            else
            {
                var conversation = await ConversationService.StartConversationAsync(match.UserId);
                if (conversation != null)
                {
                    Snackbar.Add($"Conversație începută!", Severity.Success);
                    Navigation.NavigateTo($"/conversations/{conversation.Id}");
                }
            }
        }
        catch (Exception ex) { Snackbar.Add($"Eroare: {ex.Message}", Severity.Error); }
    }
}
