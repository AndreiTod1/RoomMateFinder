@page "/register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using RoomMate_Finder_Frontend.Shared
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Înregistrare - RoomMate Finder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Class="pa-8" Elevation="4">
        <MudStack Spacing="4" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" 
                     Color="Color.Primary" 
                     Size="Size.Large" />
            <MudText Typo="Typo.h4" Class="fw-bold text-center">
                Alătură-te comunității!
            </MudText>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="text-muted">
                Creează-ți contul și începe să-ți găsești colegul perfect de cameră
            </MudText>
        </MudStack>

        <MudForm @ref="form" Model="model">
            <MudStack Spacing="3" Class="mt-6">
                
                <!-- Basic Info Section -->
                <MudText Typo="Typo.h6" Class="mb-2 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="me-2" />
                    Informații de bază
                </MudText>
                
                <MudTextField @bind-Value="model.FullName"
                              For="@(() => model.FullName)"
                              Label="Nume complet"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Badge" />

                <MudTextField @bind-Value="model.Email"
                              For="@(() => model.Email)"
                              Label="Email"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email" />

                <MudTextField @bind-Value="model.Password"
                              For="@(() => model.Password)"
                              Label="Parola"
                              Variant="Variant.Outlined"
                              InputType="@(_passwordShow ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_passwordShow ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                              OnAdornmentClick="TogglePasswordVisibility" />

                <MudDivider Class="my-4" />

                <!-- Profile Details Section -->
                <MudText Typo="Typo.h6" Class="mb-2 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBox" Class="me-2" />
                    Detalii profil (opțional)
                </MudText>

                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="model.Age"
                                         Label="Vârsta"
                                         Variant="Variant.Outlined"
                                         Min="18"
                                         Max="65"
                                         HideSpinButtons="false" />
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="model.Gender"
                                   Label="Gen"
                                   Variant="Variant.Outlined"
                                   AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@("Male")">Masculin</MudSelectItem>
                            <MudSelectItem Value="@("Female")">Feminin</MudSelectItem>
                            <MudSelectItem Value="@("Other")">Altul</MudSelectItem>
                            <MudSelectItem Value="@("Prefer not to say")">Prefer să nu spun</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <MudTextField @bind-Value="model.University"
                              Label="Universitate"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.School" />

                <MudTextField @bind-Value="model.Bio"
                              Label="Descriere scurtă despre tine"
                              Variant="Variant.Outlined"
                              Lines="3"
                              Placeholder="Spune-ne câteva cuvinte despre personalitatea ta, hobby-urile tale..." />

                <MudSelect @bind-Value="model.Lifestyle"
                           Label="Stilul tău de viață"
                           Variant="Variant.Outlined"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("studious")">Studios</MudSelectItem>
                    <MudSelectItem Value="@("social")">Sociabil</MudSelectItem>
                    <MudSelectItem Value="@("active")">Activ</MudSelectItem>
                    <MudSelectItem Value="@("quiet")">Liniștit</MudSelectItem>
                    <MudSelectItem Value="@("balanced")">Echilibrat</MudSelectItem>
                </MudSelect>

                <MudTextField @bind-Value="model.Interests"
                              Label="Interese și hobby-uri"
                              Variant="Variant.Outlined"
                              Placeholder="ex: fotbal, muzică, călătorii, gaming, citit..." />

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h6" Class="mb-2 fw-bold">
                    <MudIcon Icon="@Icons.Material.Filled.PhotoCamera" Class="me-2" />
                    Poză de profil (opțional)
                </MudText>

                <ProfilePictureUpload @ref="_registerProfilePictureUpload"
                    PreviewUrl="@_registerProfilePicturePreview"
                    OnFileSelected="@OnRegisterProfilePictureSelected" />

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mt-4">
                        @successMessage
                    </MudAlert>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4">
                        @errorMessage
                    </MudAlert>
                }

                <MudButton OnClick="HandleValidSubmit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.PersonAdd"
                           Class="mt-6">
                    @if (isLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Se înregistrează...</MudText>
                    }
                    else
                    {
                        <MudText>Creează cont</MudText>
                    }
                </MudButton>
            </MudStack>
        </MudForm>

        <MudDivider Class="my-6" />
        
        <MudStack Row Justify="Justify.Center" AlignItems="AlignItems.Center">
            <MudText>Ai deja cont?</MudText>
            <MudLink Href="/login" Color="Color.Primary">
                <MudText Class="fw-bold">Conectează-te aici</MudText>
            </MudLink>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? form;
    private readonly RegisterModel model = new();
    private string? errorMessage;
    private string? successMessage;
    private bool _passwordShow = false;
    private bool isLoading = false;
    private IBrowserFile? _registerProfilePicture;
    private string? _registerProfilePicturePreview;
    private ProfilePictureUpload? _registerProfilePictureUpload;

    private void TogglePasswordVisibility()
    {
        _passwordShow = !_passwordShow;
    }

    private async Task OnRegisterProfilePictureSelected(IBrowserFile? file)
    {
        if (file is null)
        {
            _registerProfilePicture = null;
            _registerProfilePicturePreview = null;
            return;
        }

        if (file.Size > 5 * 1024 * 1024)
        {
            errorMessage = "Fișierul este prea mare (max 5MB).";
            return;
        }

        _registerProfilePicture = file;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());
        _registerProfilePicturePreview = $"data:{file.ContentType};base64,{base64}";
    }

    private async Task HandleValidSubmit()
    {
        errorMessage = null;
        successMessage = null;
        isLoading = true;

        try
        {
            if (form != null)
            {
                await form.Validate();
                if (form.IsValid)
                {
                    using var content = new MultipartFormDataContent();

                    content.Add(new StringContent(model.Email), nameof(model.Email));
                    content.Add(new StringContent(model.Password), nameof(model.Password));
                    content.Add(new StringContent(model.FullName), nameof(model.FullName));
                    content.Add(new StringContent(model.Bio ?? string.Empty), nameof(model.Bio));
                    content.Add(new StringContent(model.Age.ToString()), nameof(model.Age));
                    content.Add(new StringContent(model.Gender ?? string.Empty), nameof(model.Gender));
                    content.Add(new StringContent(model.University ?? string.Empty), nameof(model.University));
                    content.Add(new StringContent(model.Lifestyle ?? string.Empty), nameof(model.Lifestyle));
                    content.Add(new StringContent(model.Interests ?? string.Empty), nameof(model.Interests));

                    // Get cropped image if user selected one
                    if (_registerProfilePicture != null)
                    {
                        IBrowserFile fileToUpload = _registerProfilePicture;
                        
                        // Try to get cropped version
                        if (_registerProfilePictureUpload != null)
                        {
                            try
                            {
                                var croppedBytes = await _registerProfilePictureUpload.GetCroppedImageAsync();
                                if (croppedBytes != null && croppedBytes.Length > 0)
                                {
                                    fileToUpload = new CroppedBrowserFile(croppedBytes, "profile.jpg", "image/jpeg");
                                }
                            }
                            catch (Exception cropEx)
                            {
                                Console.WriteLine($"Cropping failed, using original: {cropEx.Message}");
                            }
                        }
                        
                        var stream = fileToUpload.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
                        var fileContent = new StreamContent(stream);
                        fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(fileToUpload.ContentType);
                        content.Add(fileContent, "ProfilePicture", fileToUpload.Name);
                    }

                    var resp = await Http.PostAsync("/profiles", content);
                    if (resp.IsSuccessStatusCode)
                    {
                        successMessage = "Înregistrare realizată cu succes! Te redirectionez către login...";
                        await Task.Delay(2000);
                        Navigation.NavigateTo("/login");
                    }
                    else
                    {
                        var text = await resp.Content.ReadAsStringAsync();
                        try
                        {
                            var doc = System.Text.Json.JsonDocument.Parse(text);
                            if (doc.RootElement.TryGetProperty("message", out var msg))
                            {
                                errorMessage = msg.GetString();
                            }
                            else
                            {
                                errorMessage = "Eroare la înregistrare. Te rog să încerci din nou.";
                            }
                        }
                        catch
                        {
                            errorMessage = "Eroare la înregistrare. Te rog să încerci din nou.";
                        }
                    }
                }
            }
        }
        catch
        {
            errorMessage = "A apărut o eroare. Te rog să încerci din nou.";
        }
        finally
        {
            isLoading = false;
        }
    }

    public class RegisterModel
    {
        [Required(ErrorMessage = "Numele complet este obligatoriu")]
        public string FullName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email-ul este obligatoriu")]
        [EmailAddress(ErrorMessage = "Te rog să introduci un email valid")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Parola este obligatorie")]
        [MinLength(6, ErrorMessage = "Parola trebuie să aibă cel puțin 6 caractere")]
        public string Password { get; set; } = string.Empty;

        public string? Bio { get; set; } = string.Empty;
        
        [Range(18, 65, ErrorMessage = "Vârsta trebuie să fie între 18 și 65 de ani")]
        public int Age { get; set; } = 20;
        
        public string? Gender { get; set; } = string.Empty;
        public string? University { get; set; } = string.Empty;
        public string? Lifestyle { get; set; } = string.Empty;
        public string? Interests { get; set; } = string.Empty;
    }
}
