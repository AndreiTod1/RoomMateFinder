@page "/leave-review"
@using RoomMate_Finder_Frontend.Services
@using RoomMate_Finder_Frontend.Models
@inject IReviewService ReviewService
@inject IProfileService ProfileService
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<AuthorizeView>
    <Authorized>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="padding: 32px 16px;">
            <MudStack Spacing="4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h3" Style="font-weight: 700; color: #1a1a1a;">Lasă o recenzie</MudText>
                    <MudText Typo="Typo.body1" Style="color: #666;">Evaluează colegii tăi de cameră și ajută comunitatea</MudText>
                </MudStack>
        
        @if (reviewableMatches == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!reviewableMatches.Any())
        {
            <MudText>Nu ai niciun match pentru a lăsa o recenzie.</MudText>
        }
        else
        {
            <MudGrid Spacing="3">
                @foreach (var reviewableMatch in reviewableMatches)
                {
                    <MudItem xs="12" sm="6" md="4" @key="reviewableMatch.Match.UserId">
                        <MudCard Elevation="3" Style="height: 100%; display: flex; flex-direction: column;">
                            <MudCardHeader Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
                                <div style="display:flex; align-items:center; width:100%;">
                                    <div style="display:flex; flex-direction:column; justify-content:center;">
                                        <MudText Typo="Typo.h5" Style="font-weight: 600; margin-bottom: 4px;">@reviewableMatch.Match.FullName</MudText>
                                        <MudText Typo="Typo.body2" Style="opacity: 0.9;">Lasă o recenzie</MudText>
                                    </div>
                                    <div style="margin-left:auto; display:flex; align-items:center; justify-content:center;">
                                        @if (!string.IsNullOrEmpty(reviewableMatch.Match.ProfilePicturePath))
                                        {
                                            <MudAvatar Size="Size.Large" Style="border: 2px solid white;">
                                                <MudImage Src="@GetProfilePictureUrl(reviewableMatch.Match.ProfilePicturePath)" Alt="@reviewableMatch.Match.FullName" />
                                            </MudAvatar>
                                        }
                                        else
                                        {
                                            <MudAvatar Size="Size.Large" Color="Color.Secondary" Style="border: 2px solid white;">
                                                @reviewableMatch.Match.FullName.FirstOrDefault()
                                            </MudAvatar>
                                        }
                                    </div>
                                </div>
                            </MudCardHeader>
                            <MudCardContent Style="flex-grow: 1; padding: 24px;">
                                <MudStack Spacing="3">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.subtitle2" Style="font-weight: 500; color: #424242;">Rating</MudText>
                                        <MudRating SelectedValue="reviewableMatch.Rating" 
                                                   SelectedValueChanged="@((int val) => { reviewableMatch.Rating = val; StateHasChanged(); })" 
                                                   MaxValue="5"
                                                   Size="Size.Large"
                                                   Color="Color.Warning" />
                                    </MudStack>
                                    <MudTextField @bind-Value="reviewableMatch.Comment" 
                                                  Label="Comentariu" 
                                                  Variant="Variant.Outlined" 
                                                  Lines="4"
                                                  HelperText="Scrie impresiile tale despre acest coleg de cameră"
                                                  Margin="Margin.Dense" />
                                </MudStack>
                            </MudCardContent>
                            <MudCardActions Style="padding: 16px 24px; justify-content: flex-end;">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           Size="Size.Large"
                                           StartIcon="@Icons.Material.Filled.Send"
                                           OnClick="() => SubmitReview(reviewableMatch)"
                                           Style="text-transform: none; font-weight: 600;">
                                    Trimite recenzia
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
            </MudStack>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <MudText>Trebuie să fii autentificat pentru a lăsa o recenzie.</MudText>
    </NotAuthorized>
</AuthorizeView>

@code {
    private class ReviewableMatch
    {
        public ReviewableMatch(UserMatchDto match)
        {
            Match = match;
            Comment = string.Empty;
        }

        public UserMatchDto Match { get; }
        public int Rating { get; set; }
        public string Comment { get; set; }
    }

    private List<ReviewableMatch> reviewableMatches = new();
    private string _apiBaseUrl = "";

    protected override async Task OnInitializedAsync()
    {
        _apiBaseUrl = Configuration["ApiBaseUrl"] ?? "http://localhost:5111";
        
        var me = await ProfileService.GetCurrentAsync();
        if (me is null)
        {
            reviewableMatches = new();
            return;
        }

        var matches = await ReviewService.GetMatchesForReview(me.Id);
        reviewableMatches = matches.Select(m => new ReviewableMatch(m)).ToList();
    }

    private string GetProfilePictureUrl(string? path)
    {
        if (string.IsNullOrEmpty(path)) return "";
        return path.StartsWith("http") ? path : $"{_apiBaseUrl}{path}";
    }

    private async Task SubmitReview(ReviewableMatch reviewableMatch)
    {
        if (reviewableMatch.Rating >= 1)
        {
            try
            {
                await ReviewService.LeaveReviewAsync(reviewableMatch.Match.UserId.ToString(), reviewableMatch.Rating, reviewableMatch.Comment);
                Snackbar.Add("Recenzia a fost trimisă cu succes!", Severity.Success);
                reviewableMatches.Remove(reviewableMatch);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"A apărut o eroare: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Te rog selectează un rating.", Severity.Warning);
        }
    }
}
