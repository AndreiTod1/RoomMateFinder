@page "/conversations"
@page "/messages"
@using Microsoft.AspNetCore.Authorization
@using RoomMate_Finder_Frontend.Services
@attribute [Authorize]
@implements IDisposable
@inject IConversationService ConversationService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<PageTitle>Mesaje - RoomMate Finder</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-6">
    <MudText Typo="Typo.h4" Class="mb-6 d-flex align-center gap-2">
        <MudIcon Icon="@Icons.Material.Filled.Chat" Color="Color.Primary" />
        Mesajele mele
    </MudText>

    @if (_isLoading)
    {
        <MudPaper Class="pa-8 text-center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4 text-secondary">Se încarcă conversațiile...</MudText>
        </MudPaper>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
    }
    else if (_conversations == null || !_conversations.Any())
    {
        <MudPaper Class="pa-8 text-center" Elevation="0" Outlined="true">
            <MudIcon Icon="@Icons.Material.Filled.ChatBubbleOutline" Size="Size.Large" Color="Color.Secondary" Style="font-size: 4rem;" />
            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Nicio conversație încă</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Începeți o conversație cu proprietarii de camere pentru a le vedea aici.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/listings" StartIcon="@Icons.Material.Filled.Search">
                Caută camere
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="0" Outlined="true" Class="rounded-lg overflow-hidden">
            @foreach (var conversation in _conversations.OrderByDescending(c => c.CreatedAt))
            {
                <div class="conversation-item d-flex align-center pa-4" 
                     style="border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s;"
                     @onclick="@(() => NavigateToConversation(conversation.Id))">
                    
                    <!-- Profile Picture -->
                    @if (!string.IsNullOrEmpty(conversation.OtherUserProfilePicture))
                    {
                        <MudAvatar Size="Size.Large" Class="mr-4">
                            <MudImage Src="@GetProfilePictureUrl(conversation.OtherUserProfilePicture)" />
                        </MudAvatar>
                    }
                    else
                    {
                        <MudAvatar Size="Size.Large" Color="Color.Primary" Class="mr-4">
                            @GetInitials(conversation.OtherUserName)
                        </MudAvatar>
                    }
                    
                    <!-- User Info -->
                    <div style="flex-grow: 1;">
                        <div class="d-flex align-center gap-2 mb-1">
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">@conversation.OtherUserName</MudText>
                            @if (!string.IsNullOrEmpty(conversation.OtherUserRole))
                            {
                                <MudChip T="string" 
                                         Size="Size.Small" 
                                         Color="@(conversation.OtherUserRole == "Admin" ? Color.Warning : Color.Default)"
                                         Variant="Variant.Text"
                                         Style="font-size: 0.7rem; height: 20px;">
                                    @conversation.OtherUserRole
                                </MudChip>
                            }
                        </div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="d-flex align-center gap-1">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                            @GetRelativeTime(conversation.CreatedAt)
                        </MudText>
                    </div>
                    
                    <!-- Arrow with notification badge -->
                    <div class="d-flex align-center gap-2">
                        @if (NotificationService.HasUnreadMessages(conversation.Id))
                        {
                            <MudChip T="string" 
                                     Size="Size.Small" 
                                     Color="Color.Error"
                                     Style="font-size: 0.7rem; height: 22px; font-weight: 600;">
                                NOU
                            </MudChip>
                        }
                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" 
                                 Color="@(NotificationService.HasUnreadMessages(conversation.Id) ? Color.Primary : Color.Secondary)" />
                    </div>
                </div>
            }
        </MudPaper>
        
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-4 text-center">
            @_conversations.Count conversații
        </MudText>
    }
</MudContainer>

<style>
    .conversation-item:hover {
        background-color: rgba(0,0,0,0.04);
    }
</style>

@code {
    private List<ConversationDto>? _conversations;
    private bool _isLoading = true;
    private string? _errorMessage;
    private string _apiBaseUrl = "";

    protected override async Task OnInitializedAsync()
    {
        _apiBaseUrl = Configuration["ApiBaseUrl"] ?? "";
        NotificationService.OnNotificationsChanged += HandleNotificationsChanged;
        await LoadConversations();
    }

    private void HandleNotificationsChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadConversations()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _conversations = await ConversationService.GetConversationsAsync();
        }
        catch (UnauthorizedAccessException)
        {
            _errorMessage = "Nu sunteți autentificat. Vă rugăm să vă autentificați.";
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"A apărut o eroare: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task NavigateToConversation(Guid conversationId)
    {
        await NotificationService.MarkConversationAsReadAsync(conversationId);
        Navigation.NavigateTo($"/conversations/{conversationId}");
    }
    
    private string GetProfilePictureUrl(string path)
    {
        if (string.IsNullOrEmpty(path)) return "";
        return path.StartsWith("http") ? path : $"{_apiBaseUrl}{path}";
    }
    
    private static string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
    
    private static string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        if (timeSpan.TotalMinutes < 1)
            return "Acum";
        if (timeSpan.TotalMinutes < 60)
            return $"Acum {(int)timeSpan.TotalMinutes} min";
        if (timeSpan.TotalHours < 24)
            return $"Acum {(int)timeSpan.TotalHours} ore";
        if (timeSpan.TotalDays < 7)
            return $"Acum {(int)timeSpan.TotalDays} zile";
        if (timeSpan.TotalDays < 30)
            return $"Acum {(int)(timeSpan.TotalDays / 7)} săptămâni";
        if (timeSpan.TotalDays < 365)
            return $"Acum {(int)(timeSpan.TotalDays / 30)} luni";
        
        return dateTime.ToLocalTime().ToString("dd MMM yyyy");
    }

    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= HandleNotificationsChanged;
    }
}

