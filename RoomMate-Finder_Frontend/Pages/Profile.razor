@page "/profile/{Id:guid}"
@using RoomMate_Finder_Frontend.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using RoomMate_Finder_Frontend.Models
@using RoomMate_Finder_Frontend.Shared
@inject IProfileService ProfileService
@inject NavigationManager Navigation

<PageTitle>@(_profile?.FullName ?? "Profil") - RoomMate Finder</PageTitle>

@if (!string.IsNullOrEmpty(_error))
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="py-8">
        <MudAlert Severity="Severity.Error">
            <MudText>@_error</MudText>
        </MudAlert>
        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Navigation.NavigateTo("/profiles"))" Class="mt-4">
            Înapoi la Lista de Profile
        </MudButton>
    </MudContainer>
}
else if (_profile == null)
{
    <MudContainer MaxWidth="MaxWidth.Medium" Class="py-8 text-center">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        <MudText Typo="Typo.h6" Class="mt-4">Se încarcă profilul...</MudText>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
        <!-- Header with Back Button -->
        <MudStack Row AlignItems="AlignItems.Center" Class="mb-6">
            <MudButton Variant="Variant.Text" 
                       StartIcon="@Icons.Material.Filled.ArrowBack" 
                       OnClick="@(() => Navigation.NavigateTo("/profiles"))"
                       Color="Color.Primary">
                Înapoi la Profile
            </MudButton>
            <MudSpacer />
            @if (!_isEditing && _isCurrentUserProfile)
            {
                <MudButton Variant="Variant.Outlined" 
                           StartIcon="@Icons.Material.Filled.Edit" 
                           OnClick="EnableEdit"
                           Color="Color.Primary">
                    Editează Profilul
                </MudButton>
            }
        </MudStack>

        @if (_isEditing)
        {
            <!-- Edit Mode -->
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="me-2" />
                            Editează Profilul
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudForm @ref="_form" Model="_editModel">
                        <MudGrid Spacing="3">
                            <!-- Left Column - All text fields -->
                            <MudItem xs="12" md="7">
                                <MudGrid Spacing="2">
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_editModel.FullName"
                                                      For="@(() => _editModel.FullName)"
                                                      Label="Nume Complet"
                                                      Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudNumericField @bind-Value="_editModel.Age"
                                                         Label="Vârsta"
                                                         Variant="Variant.Outlined"
                                                         Min="18" Max="65" />
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudSelect @bind-Value="_editModel.Gender"
                                                   Label="Gen"
                                                   Variant="Variant.Outlined">
                                            <MudSelectItem Value="@("Male")">Masculin</MudSelectItem>
                                            <MudSelectItem Value="@("Female")">Feminin</MudSelectItem>
                                            <MudSelectItem Value="@("Other")">Altul</MudSelectItem>
                                            <MudSelectItem Value="@("Prefer not to say")">Prefer să nu spun</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudTextField @bind-Value="_editModel.University"
                                                      Label="Universitate"
                                                      Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudSelect @bind-Value="_editModel.Lifestyle"
                                                   Label="Stilul de viață"
                                                   Variant="Variant.Outlined">
                                            <MudSelectItem Value="@("studious")">Studios</MudSelectItem>
                                            <MudSelectItem Value="@("social")">Sociabil</MudSelectItem>
                                            <MudSelectItem Value="@("active")">Activ</MudSelectItem>
                                            <MudSelectItem Value="@("quiet")">Liniștit</MudSelectItem>
                                            <MudSelectItem Value="@("balanced")">Echilibrat</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_editModel.Bio"
                                                      Label="Despre mine"
                                                      Lines="3"
                                                      Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_editModel.Interests"
                                                      Label="Interese și hobby-uri"
                                                      Variant="Variant.Outlined"
                                                      Placeholder="ex: fotbal, muzică, călătorii..." />
                                    </MudItem>
                                </MudGrid>
                            </MudItem>

                            <!-- Right Column - Only photo -->
                            <MudItem xs="12" md="5">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.PhotoCamera" Size="Size.Small" Class="me-1" />
                                    Poză de profil
                                </MudText>
                                <ProfilePictureUpload @ref="_profilePictureUpload"
                                    PreviewUrl="@GetPreviewUrl()"
                                    OnFileSelected="@OnProfilePictureSelected" />
                            </MudItem>
                        </MudGrid>
                    </MudForm>
                </MudCardContent>
                <MudCardActions>
                    <MudButton OnClick="HandleValidSubmit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               Disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <span class="ms-2">Salvez...</span>
                        }
                        else
                        {
                            <span>Salvează</span>
                        }
                    </MudButton>
                    <MudButton OnClick="CancelEdit"
                               Variant="Variant.Text"
                               StartIcon="@Icons.Material.Filled.Cancel"
                               Disabled="@_isSaving">
                        Anulează
                    </MudButton>
                </MudCardActions>
            </MudCard>
        }
        else
        {
            <!-- View Mode -->
            <MudGrid Spacing="4">
                <!-- Profile Header Card -->
                <MudItem xs="12">
                    <MudCard Elevation="3">
                        <MudCardContent Class="pa-6">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="4">
                                <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 120px; height: 120px; font-size: 2.5rem;">
                                    <img src="@GetProfileImageUrl(_profile.ProfilePicturePath)" alt="Profile picture" style="width:100%;height:100%;object-fit:cover;" />
                                </MudAvatar>
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h3" Class="fw-bold">@_profile.FullName</MudText>
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        <MudChip T="string" Icon="@Icons.Material.Filled.Cake" Color="Color.Info" Size="Size.Small">
                                            @_profile.Age ani
                                        </MudChip>
                                        @if (!string.IsNullOrEmpty(_profile.Gender))
                                        {
                                            <MudChip T="string" Icon="@Icons.Material.Filled.Person" Color="Color.Secondary" Size="Size.Small">
                                                @_profile.Gender
                                            </MudChip>
                                        }
                                    </MudStack>
                                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="me-1" />
                                        @_profile.Email
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- University and Lifestyle -->
                <MudItem xs="12" md="6">
                    <MudCard Class="h-100">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.School" Class="me-2" />
                                    Educație și Stil de Viață
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                @if (!string.IsNullOrEmpty(_profile.University))
                                {
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.School" Color="Color.Primary" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Universitatea</MudText>
                                            <MudText Typo="Typo.body1">@_profile.University</MudText>
                                        </MudStack>
                                    </MudStack>
                                }

                                @if (!string.IsNullOrEmpty(_profile.Lifestyle))
                                {
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Secondary" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Stilul de Viață</MudText>
                                            <MudText Typo="Typo.body1" Class="text-capitalize">@_profile.Lifestyle</MudText>
                                        </MudStack>
                                    </MudStack>
                                }

                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Tertiary" />
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Membru din</MudText>
                                        <MudText Typo="Typo.body1">@_profile.CreatedAt.ToString("dd MMMM yyyy")</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Interests -->
                <MudItem xs="12" md="6">
                    <MudCard Class="h-100">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Star" Class="me-2" />
                                    Interese și Hobby-uri
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (!string.IsNullOrEmpty(_profile.Interests))
                            {
                                <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                                    @foreach (var interest in _profile.Interests.Split(',').Select(i => i.Trim()).Where(i => !string.IsNullOrEmpty(i)))
                                    {
                                        <MudChip T="string" Text="@interest" Color="Color.Primary" Size="Size.Small" />
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Nu au fost adăugate încă interese.
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Bio -->
                <MudItem xs="12">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.Description" Class="me-2" />
                                    Despre Mine
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (!string.IsNullOrEmpty(_profile.Bio))
                            {
                                <MudText Typo="Typo.body1" Style="line-height: 1.6;">
                                    @_profile.Bio
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Această persoană nu a adăugat încă o descriere.
                                </MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Reviews section (new) -->
                <MudItem xs="12">
                    <MudCard Class="mt-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.RateReview" Class="me-2" />
                                    Recenzii primite
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (_reviews == null)
                            {
                                <MudProgressCircular Indeterminate="true" />
                            }
                            else if (!_reviews.Any())
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Acest utilizator nu are încă recenzii.
                                </MudText>
                            }
                            else
                            {
                                <MudList T="Review">
                                    @foreach (var review in _reviews)
                                    {
                                        <MudListItem T="Review">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.subtitle2">@review.ReviewerFullName</MudText>
                                                <MudRating SelectedValue="review.Rating" ReadOnly="true" MaxValue="5" Size="Size.Small" />
                                                @if (!string.IsNullOrWhiteSpace(review.Comment))
                                                {
                                                    <MudText Typo="Typo.body2">@review.Comment</MudText>
                                                }
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @review.CreatedAt.ToString("dd MMM yyyy, HH:mm")
                                                </MudText>
                                            </MudStack>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }
    </MudContainer>
}

<style>
    .text-capitalize {
        text-transform: capitalize;
    }
</style>

@code {
    [Parameter]
    public Guid Id { get; set; }

    [Inject]
    private HttpClient Http { get; set; } = default!;

    private ProfileDto? _profile;
    private string? _error;
    private bool _isEditing;
    private bool _isCurrentUserProfile;
    private EditModel _editModel = new();
    private bool _isSaving;
    private MudForm? _form;
    private IBrowserFile? _newProfilePicture;
    private string? _newProfilePicturePreview;
    private ProfilePictureUpload? _profilePictureUpload;
    private long _imageCacheBuster = DateTime.UtcNow.Ticks;
    private IEnumerable<Review>? _reviews;

    public class EditModel
    {
        [Required(ErrorMessage = "Numele complet este obligatoriu")]
        public string FullName { get; set; } = string.Empty;
        
        [Range(18, 65, ErrorMessage = "Vârsta trebuie să fie între 18 și 65 de ani")]
        public int Age { get; set; } = 20;
        
        public string? Gender { get; set; }
        public string? University { get; set; }
        public string? Bio { get; set; }
        public string? Lifestyle { get; set; }
        public string? Interests { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _profile = await ProfileService.GetByIdAsync(Id);
            if (_profile == null)
            {
                _error = "Profilul nu a fost găsit.";
                return;
            }

            // Check if this is the current user's profile
            var currentProfile = await ProfileService.GetCurrentAsync();
            _isCurrentUserProfile = currentProfile?.Id == Id;

            // populate edit model only if it's the current user's profile
            if (_isCurrentUserProfile)
            {
                _editModel = new EditModel
                {
                    FullName = _profile.FullName,
                    Age = _profile.Age,
                    Gender = _profile.Gender,
                    University = _profile.University,
                    Bio = _profile.Bio,
                    Lifestyle = _profile.Lifestyle,
                    Interests = _profile.Interests
                };
            }

            if (_profile != null)
            {
                _reviews = await ProfileService.GetUserReviews(_profile.Id);
            }
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private void EnableEdit() => _isEditing = true;
    
    private void CancelEdit()
    {
        _isEditing = false;
        // reset model to original
        if (_profile != null)
        {
            _editModel.FullName = _profile.FullName;
            _editModel.Age = _profile.Age;
            _editModel.Gender = _profile.Gender;
            _editModel.University = _profile.University;
            _editModel.Bio = _profile.Bio;
            _editModel.Lifestyle = _profile.Lifestyle;
            _editModel.Interests = _profile.Interests;
        }
    }

    private async Task OnProfilePictureSelected(IBrowserFile? file)
    {
        if (file is null)
        {
            _newProfilePicture = null;
            _newProfilePicturePreview = null;
            return;
        }

        if (file.Size > 5 * 1024 * 1024)
        {
            // optionally set an error message here
            return;
        }

        _newProfilePicture = file;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());
        _newProfilePicturePreview = $"data:{file.ContentType};base64,{base64}";
    }

    private async Task HandleValidSubmit()
    {
        if (_profile == null || _form == null) return;
        
        await _form.Validate();
        if (!_form.IsValid) return;
        
        _isSaving = true;
        try
        {
            var updateDto = new UpdateProfileRequestDto(
                _editModel.FullName,
                _editModel.Age,
                _editModel.Gender,
                _editModel.University,
                _editModel.Bio,
                _editModel.Lifestyle,
                _editModel.Interests
            );

            // Get cropped image if user selected a new one
            IBrowserFile? fileToUpload = _newProfilePicture;
            
            if (_newProfilePicture != null && _profilePictureUpload != null)
            {
                try
                {
                    var croppedBytes = await _profilePictureUpload.GetCroppedImageAsync();
                    if (croppedBytes != null && croppedBytes.Length > 0)
                    {
                        // Create a custom IBrowserFile from cropped bytes
                        fileToUpload = new CroppedBrowserFile(croppedBytes, "profile.jpg", "image/jpeg");
                    }
                }
                catch (Exception cropEx)
                {
                    Console.WriteLine($"Cropping failed, using original: {cropEx.Message}");
                    // Fall back to original file if cropping fails
                }
            }

            var updated = await ProfileService.UpdateAsync(_profile!.Id, updateDto, fileToUpload);
            if (updated != null)
            {
                _profile = updated;
                _isEditing = false;
                _newProfilePicturePreview = null;
                _newProfilePicture = null;
                // Force image reload by updating cache buster
                _imageCacheBuster = DateTime.UtcNow.Ticks;
            }
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private string GetInitials()
    {
        if (_profile == null || string.IsNullOrEmpty(_profile.FullName)) return "?";
        
        var parts = _profile.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return "?";
        
        var first = char.ToUpper(parts[0][0]);
        var second = parts.Length > 1 ? char.ToUpper(parts[1][0]) : '\0';
        return second == '\0' ? first.ToString() : $"{first}{second}";
    }

    private string GetFullImageUrl(string? relativePath)
    {
        if (string.IsNullOrEmpty(relativePath))
            return string.Empty;
            
        if (relativePath.StartsWith("http") || relativePath.StartsWith("data:"))
            return relativePath;
            
        var baseUrl = Http.BaseAddress?.ToString().TrimEnd('/') ?? "http://localhost:5111";
        return $"{baseUrl}{relativePath}?v={_imageCacheBuster}";
    }

    private string GetProfileImageUrl(string? relativePath)
    {
        if (string.IsNullOrEmpty(relativePath))
        {
            // Generate a nice default avatar using ui-avatars.com with user's name
            var name = Uri.EscapeDataString(_profile?.FullName ?? "User");
            return $"https://ui-avatars.com/api/?name={name}&background=6366f1&color=fff&size=200&bold=true";
        }
            
        return GetFullImageUrl(relativePath);
    }

    private string GetPreviewUrl()
    {
        // If we have a new preview (data URL from file selection), use it
        if (!string.IsNullOrEmpty(_newProfilePicturePreview))
            return _newProfilePicturePreview;
            
        // Otherwise use the existing profile picture with full URL
        if (!string.IsNullOrEmpty(_profile?.ProfilePicturePath))
            return GetFullImageUrl(_profile.ProfilePicturePath);
            
        return string.Empty;
    }
}
