@page "/admin/listings"
@using Microsoft.AspNetCore.Authorization
@using RoomMate_Finder_Frontend.Services
@attribute [Authorize(Roles = "Admin")]
@inject IListingService ListingService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IConfiguration Configuration

<PageTitle>Admin - Listings</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h5" Class="fw-bold">Manage Listings</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">View and manage all room listings</MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/create-listing">
            New Listing
        </MudButton>
    </div>

    @if (_isLoading)
    {
        <MudPaper Elevation="0" Outlined="true" Class="rounded-lg">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        </MudPaper>
    }
    else if (_listings.Count == 0)
    {
        <MudPaper Elevation="0" Outlined="true" Class="rounded-lg">
            <div class="pa-8 d-flex flex-column align-center">
                <MudIcon Icon="@Icons.Material.Filled.HomeWork" Size="Size.Large" Color="Color.Secondary" Class="mb-4" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">No listings yet</MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/create-listing" Class="mt-4">
                    Create First Listing
                </MudButton>
            </div>
        </MudPaper>
    }
    else
    {
        @* Active Listings *@
        @if (ActiveListings.Any())
        {
            <MudText Typo="Typo.h6" Class="mb-3 d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                Active Listings (@ActiveListings.Count())
            </MudText>
            <MudPaper Elevation="0" Outlined="true" Class="rounded-lg mb-6">
                @foreach (var listing in ActiveListings)
                {
                    <div class="d-flex align-center pa-4" style="border-bottom: 1px solid #eee; cursor: pointer;" @onclick="@(() => ViewListing(listing.Id))">
                        @if (!string.IsNullOrEmpty(listing.ThumbnailPath))
                        {
                            <MudImage Src="@GetImageUrl(listing.ThumbnailPath)" 
                                      Alt="@listing.Title"
                                      ObjectFit="ObjectFit.Cover"
                                      Class="rounded mr-4"
                                      Style="width: 60px; height: 45px; object-fit: cover;" />
                        }
                        else
                        {
                            <MudAvatar Size="Size.Medium" Color="Color.Tertiary" Variant="Variant.Filled" Class="mr-4" Style="width: 60px; height: 45px; border-radius: 4px;">
                                <MudIcon Icon="@Icons.Material.Filled.Home" />
                            </MudAvatar>
                        }

                        <div style="flex-grow: 1;">
                            <div class="d-flex align-center gap-2">
                                <MudText Typo="Typo.subtitle2" Class="fw-bold">@listing.Title</MudText>
                                @if (listing.AvailableFrom <= DateTime.UtcNow)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text" Style="font-size: 0.7rem; height: 20px;">AVAILABLE</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text" Style="font-size: 0.7rem; height: 20px;">
                                        FROM @listing.AvailableFrom.ToString("dd MMM yyyy")
                                    </MudChip>
                                }
                            </div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@listing.City, @listing.Area • €@listing.Price/mo • by @listing.OwnerFullName</MudText>
                        </div>

                        <div class="d-flex gap-1" @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info" 
                                           OnClick="@(() => ViewListing(listing.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" 
                                           OnClick="@(() => EditListing(listing.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline" Size="Size.Small" Color="Color.Error" 
                                           OnClick="@(() => DeleteListing(listing))" />
                        </div>
                    </div>
                }
            </MudPaper>
        }

        @* Inactive Listings *@
        @if (InactiveListings.Any())
        {
            <MudText Typo="Typo.h6" Class="mb-3 d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                Inactive Listings (@InactiveListings.Count())
            </MudText>
            <MudPaper Elevation="0" Outlined="true" Class="rounded-lg" Style="opacity: 0.85;">
                @foreach (var listing in InactiveListings)
                {
                    <div class="d-flex align-center pa-4" style="border-bottom: 1px solid #eee; background: #f9f9f9; cursor: pointer;" @onclick="@(() => ViewListing(listing.Id))">
                        @if (!string.IsNullOrEmpty(listing.ThumbnailPath))
                        {
                            <MudImage Src="@GetImageUrl(listing.ThumbnailPath)" 
                                      Alt="@listing.Title"
                                      ObjectFit="ObjectFit.Cover"
                                      Class="rounded mr-4"
                                      Style="width: 60px; height: 45px; object-fit: cover; filter: grayscale(50%);" />
                        }
                        else
                        {
                            <MudAvatar Size="Size.Medium" Color="Color.Default" Variant="Variant.Filled" Class="mr-4" Style="width: 60px; height: 45px; border-radius: 4px;">
                                <MudIcon Icon="@Icons.Material.Filled.Home" />
                            </MudAvatar>
                        }

                        <div style="flex-grow: 1;">
                            <div class="d-flex align-center gap-2">
                                <MudText Typo="Typo.subtitle2" Class="fw-bold">@listing.Title</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text" Style="font-size: 0.7rem; height: 20px;">INACTIVE</MudChip>
                            </div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@listing.City, @listing.Area • €@listing.Price/mo • by @listing.OwnerFullName</MudText>
                        </div>

                        <div class="d-flex gap-1" @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info" 
                                           OnClick="@(() => ViewListing(listing.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" 
                                           OnClick="@(() => EditListing(listing.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.DeleteOutline" Size="Size.Small" Color="Color.Error" 
                                           OnClick="@(() => DeleteListing(listing))" />
                        </div>
                    </div>
                }
            </MudPaper>
        }

        <div class="d-flex justify-center pa-4">
            <MudPagination Color="Color.Primary" Count="@TotalPages" Selected="@_currentPage" SelectedChanged="OnPageChanged" Size="Size.Small" />
        </div>
    }
</MudContainer>

@code {
    private List<ListingSummaryDto> _listings = new();
    private bool _isLoading = true;
    private int _currentPage = 1;
    private readonly int _pageSize = 15;
    private int _totalCount;
    private int TotalPages => (int)Math.Ceiling((double)_totalCount / _pageSize);
    private string _apiBaseUrl = "";

    private IEnumerable<ListingSummaryDto> ActiveListings => _listings.Where(l => l.IsActive);
    private IEnumerable<ListingSummaryDto> InactiveListings => _listings.Where(l => !l.IsActive);

    protected override async Task OnInitializedAsync()
    {
        // Fallback URL for local development
        _apiBaseUrl = Configuration["ApiBaseUrl"] ?? "http://localhost:5111";
        await LoadListings();
    }

    private async Task LoadListings()
    {
        _isLoading = true;
        try
        {
            var response = await ListingService.SearchAsync(new ListingsSearchRequest(
                Page: _currentPage, 
                PageSize: _pageSize, 
                IncludeInactive: true
            ));
            _listings = response.Listings;
            _totalCount = response.TotalCount;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading listings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadListings();
    }

    private void ViewListing(Guid id) => Navigation.NavigateTo($"/room/{id}");
    private void EditListing(Guid id) => Navigation.NavigateTo($"/edit-listing/{id}");
    
    private string GetImageUrl(string path)
    {
        return path.StartsWith("http") ? path : $"{_apiBaseUrl}{path}";
    }

    private async Task DeleteListing(ListingSummaryDto listing)
    {
        var confirm = await DialogService.ShowMessageBox("Delete Listing", $"Delete '{listing.Title}'?", yesText: "Delete", cancelText: "Cancel");
        if (confirm == true)
        {
            try
            {
                await ListingService.DeleteAsync(listing.Id);
                Snackbar.Add("Listing deleted", Severity.Success);
                await LoadListings();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}

