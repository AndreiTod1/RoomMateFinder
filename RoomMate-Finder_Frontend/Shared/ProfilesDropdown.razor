@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using RoomMate_Finder_Frontend.Services
@inject NavigationManager Navigation
@inject IProfileService ProfileService
@inject AuthenticationStateProvider AuthStateProvider

<div class="position-relative d-inline-block">
    <button class="btn btn-outline-light btn-sm me-2" @onclick="Toggle" aria-expanded="@_open">
        <span class="bi bi-people me-1" aria-hidden="true"></span> CautÄƒ colegi
    </button>

    @if (_open)
    {
        <ul class="dropdown-menu dropdown-menu-end show" style="min-width: 180px; display: block;">
            <li><a class="dropdown-item" href="profiles" @onclick="Close">Toate profilurile</a></li>
            <li><a class="dropdown-item" href="#" @onclick="GoToMyProfile" @onclick:preventDefault>Profilul meu</a></li>
        </ul>
    }
</div>

@code {
    private bool _open;

    private void Toggle()
    {
        _open = !_open;
    }

    private void Close()
    {
        _open = false;
    }

    private async Task GoToMyProfile()
    {
        Close();
        try
        {
            var profile = await ProfileService.GetCurrentAsync();
            if (profile != null)
            {
                Navigation.NavigateTo($"/profile/{profile.Id.ToString()}");
                return;
            }
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        catch
        {
            // ignore and fallback
        }

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? user.FindFirst("sub")?.Value;
                if (Guid.TryParse(idClaim ?? string.Empty, out Guid id))
                {
                    Navigation.NavigateTo($"/profile/{id.ToString()}");
                    return;
                }
            }
        }
        catch
        {
            // ignore
        }

        Navigation.NavigateTo("/profiles");
    }
}
